Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _jsxFileName="src/components/Carousel/index.js";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _react=require("react");var _react2=_interopRequireDefault(_react);var _propTypes=require("prop-types");var _propTypes2=_interopRequireDefault(_propTypes);var _reactNative=require("react-native");var _Theme=require("../Theme");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}var Carousel=function(_Component){_inherits(Carousel,_Component);function Carousel(props){_classCallCheck(this,Carousel);var _this=_possibleConstructorReturn(this,(Carousel.__proto__||Object.getPrototypeOf(Carousel)).call(this,props));_this.autoPlayTimer=0;_this.currentIndex=0;_this.panStartIndex=0;_this.panOffsetFactor=0;_this.state={scrollValue:new _reactNative.Animated.Value(0)};return _this;}_createClass(Carousel,[{key:"componentWillMount",value:function componentWillMount(){var _this2=this;this.panResponder=_reactNative.PanResponder.create({onStartShouldSetPanResponder:function onStartShouldSetPanResponder(){_this2.startPanResponder();return true;},onMoveShouldSetPanResponder:function onMoveShouldSetPanResponder(e,g){if(Math.abs(g.dx)>Math.abs(g.dy)){_this2.startPanResponder();return true;}else{return false;}},onPanResponderTerminationRequest:function onPanResponderTerminationRequest(){return false;},onPanResponderGrant:function onPanResponderGrant(){_this2.startPanResponder();},onPanResponderStart:function onPanResponderStart(e,g){_this2.startPanResponder();},onPanResponderMove:function onPanResponderMove(e,g){_this2.panOffsetFactor=_this2.computePanOffset(g);_this2.gotoPage(_this2.panStartIndex+_this2.panOffsetFactor,false);},onPanResponderEnd:function onPanResponderEnd(e,g){_this2.endPanResponder(g);_this2.scrollView.scrollTo({x:0,animated:false});}});}},{key:"componentDidMount",value:function componentDidMount(){if(this.props.autoplay){this.startAutoPlay();}this.gotoPage(this.props.index+(this.props.loop?1:0),false);}},{key:"componentWillReceiveProps",value:function componentWillReceiveProps(nextProps){if(nextProps.autoplay){this.startAutoPlay();}else{this.stopAutoPlay();}}},{key:"startAutoPlay",value:function startAutoPlay(){var _this3=this;this.stopAutoPlay();if(!this.autoPlayTimer){this.autoPlayTimer=setInterval(function(){_this3.gotoNextPage();},this.props.autoplayTimeout);}}},{key:"stopAutoPlay",value:function stopAutoPlay(){if(this.autoPlayTimer){clearInterval(this.autoPlayTimer);this.autoPlayTimer=0;}}},{key:"computePanOffset",value:function computePanOffset(g){var offset=-g.dx/(this.props.width/this.props.slipFactor);if(Math.abs(offset)>1){offset=offset>1?1:-1;}return offset;}},{key:"startPanResponder",value:function startPanResponder(){this.stopAutoPlay();this.panStartIndex=this.currentIndex;this.panOffsetFactor=0;if(this.pageAnimation){var index=this.currentIndex;this.pageAnimation.stop();this.gotoPage(index);}}},{key:"endPanResponder",value:function endPanResponder(g){if(this.props.autoplay){this.startAutoPlay();}var newIndex=this.currentIndex;this.panOffsetFactor=this.computePanOffset(g);if(this.panOffsetFactor>0.5||this.panOffsetFactor>0&&g.vx<=-0.1){newIndex=Math.floor(this.currentIndex+1);}else if(this.panOffsetFactor<-0.5||this.panOffsetFactor<0&&g.vx>=0.1){newIndex=Math.ceil(this.currentIndex-1);}else{newIndex=Math.round(this.currentIndex);}if(this.currentIndex===newIndex){return;}this.gotoPage(newIndex);}},{key:"gotoNextPage",value:function gotoNextPage(){var animated=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;var childrenNum=this.getChildrenNum();if(!this.props.loop){if(this.currentIndex===childrenNum-1){return;}}this.gotoPage(Math.floor(this.currentIndex)+1);}},{key:"gotoPage",value:function gotoPage(index){var _this4=this;var animated=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var cb=arguments.length>2&&arguments[2]!==undefined?arguments[2]:function(){};var childrenNum=this.getChildrenNum();if(childrenNum<=1){return cb();}if(index<0){index=0;}if(index>childrenNum-1){index=childrenNum-1;}var setIndex=function setIndex(index){_this4.currentIndex=index;if(_this4.props.onPageChanged&&Number.isInteger(_this4.currentIndex)){_this4.props.onPageChanged(_this4.getCurrentPage());}};if(animated){this.pageAnimation=this.props.animation(this.state.scrollValue,index);var animationId=this.state.scrollValue.addListener(function(state){setIndex(state.value);});this.pageAnimation.start(function(){_this4.state.scrollValue.removeListener(animationId);setIndex(index);_this4.pageAnimation=null;_this4.loopJump();cb();});}else{this.state.scrollValue.setValue(index);setIndex(index);this.loopJump();cb();}}},{key:"getCurrentPage",value:function getCurrentPage(){var childrenNum=this.getChildrenNum();if(childrenNum<=1){return childrenNum;}var index=this.currentIndex;if(this.props.loop){if(index<0.5){return index+childrenNum-2-1;}else if(index>childrenNum-2+0.5){return index-childrenNum+1;}else{return index-1;}}else{return index;}}},{key:"loopJump",value:function loopJump(){if(!this.props.loop){return;}var childrenNum=this.getChildrenNum();if(childrenNum<=1){return;}if(this.currentIndex===0){this.gotoPage(childrenNum-2,false);}else if(this.currentIndex===childrenNum-1){this.gotoPage(1,false);}}},{key:"getChildrenNum",value:function getChildrenNum(){var _props=this.props,children=_props.children,loop=_props.loop;var pages=_react2.default.Children.toArray(children);if(pages.length<2){return 1;}if(loop){return pages.length+2;}else{return pages.length;}}},{key:"renderIndicator",value:function renderIndicator(config){if(!this.props.showsPageIndicator){return null;}if(this.props.renderPageIndicator){return this.props.renderPageIndicator(config);}var childrenNum=config.childrenNum,pageNum=config.pageNum,loop=config.loop,scrollValue=config.scrollValue;if(pageNum===0){return null;}var indicators=[];for(var i=0;i<pageNum;i++){indicators.push(_react2.default.createElement(_reactNative.View,{key:i,style:[this.props.theme.pageIndicatorStyle,this.props.pageIndicatorStyle],__source:{fileName:_jsxFileName,lineNumber:298}}));}var offset=this.props.pageIndicatorOffset;var left=void 0;if(pageNum===1){left=this.state.scrollValue.interpolate({inputRange:[0,1],outputRange:[0,0]});}else if(!loop){left=this.state.scrollValue.interpolate({inputRange:[0,1],outputRange:[0,offset]});}else{left=this.state.scrollValue.interpolate({inputRange:[0,1,2,childrenNum-2,childrenNum-1],outputRange:[0,0,offset,offset*(childrenNum-3),offset*(childrenNum-3)]});}return _react2.default.createElement(_reactNative.View,{style:[this.props.theme.pageIndicatorContainerStyle,this.props.pageIndicatorContainerStyle],__source:{fileName:_jsxFileName,lineNumber:336}},indicators,_react2.default.createElement(_reactNative.Animated.View,{style:[this.props.theme.pageIndicatorStyle,this.props.theme.activePageIndicatorStyle,this.props.pageIndicatorStyle,this.props.activePageIndicatorStyle,{left:left}],__source:{fileName:_jsxFileName,lineNumber:343}}));}},{key:"render",value:function render(){var _this5=this;var _props2=this.props,children=_props2.children,width=_props2.width,height=_props2.height,loop=_props2.loop,theme=_props2.theme;var scrollValue=this.state.scrollValue;var pages=_react2.default.Children.toArray(children);var pageNum=pages.length;if(loop&&pages.length>1){pages.unshift(pages[pages.length-1]);pages.push(pages[1]);}pages=pages.map(function(page,index){return _react2.default.createElement(_reactNative.View,{key:index,style:{width:width},__source:{fileName:_jsxFileName,lineNumber:369}},page);});var childrenNum=pages.length;var content=null;if(childrenNum>0){var translateX=scrollValue.interpolate({inputRange:[0,1,childrenNum],outputRange:[0,-width,-childrenNum*width]});content=_react2.default.createElement(_reactNative.Animated.View,_extends({style:{flexDirection:"row",width:width*childrenNum,transform:[{translateX:translateX}]}},this.panResponder.panHandlers,{__source:{fileName:_jsxFileName,lineNumber:384}}),pages);}return _react2.default.createElement(_reactNative.View,{style:{width:width,height:height},__source:{fileName:_jsxFileName,lineNumber:397}},_react2.default.createElement(_reactNative.ScrollView,{className:"foo-bar",ref:function ref(_ref){return _this5.scrollView=_ref;},style:[theme.scrollView,{width:width,height:height}],contentContainerStyle:{width:width+1,height:width+1},horizontal:true,pagingEnabled:true,directionalLockEnabled:true,bounces:false,alwaysBounceHorizontal:false,alwaysBounceVertical:false,showsVerticalScrollIndicator:false,showsHorizontalScrollIndicator:false,scrollEnabled:_reactNative.Platform.OS==="ios"?true:false,__source:{fileName:_jsxFileName,lineNumber:398}},content),this.renderIndicator({childrenNum:childrenNum,pageNum:pageNum,loop:loop,scrollValue:scrollValue}));}}]);return Carousel;}(_react.Component);Carousel.themeConfig={style:{scrollView:{overflowX:_reactNative.Platform.OS==="web"?"hidden":undefined},pageIndicatorStyle:{width:6,height:6,borderRadius:3,marginHorizontal:5,backgroundColor:"rgba(0,0,0,.4)"},activePageIndicatorStyle:{position:"absolute",backgroundColor:"@primaryColor"},pageIndicatorContainerStyle:{position:"absolute",alignSelf:"center",flexDirection:"row",bottom:20}}};Carousel.defaultProps={width:_reactNative.Dimensions.get("window").width,height:_reactNative.Dimensions.get("window").height,index:0,loop:true,autoplay:true,autoplayTimeout:5000,slipFactor:1,showsPageIndicator:true,pageIndicatorOffset:16,animation:function animation(animate,toValue){return _reactNative.Animated.spring(animate,{toValue:toValue,friction:10,tension:50});}};exports.default=(0,_Theme.withTheme)("Carousel",Carousel);module.exports=exports["default"];